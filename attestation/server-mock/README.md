![Marlin Oyster Logo](./logo.svg)

# Attestation Server Mock

The mock attestation server generates attestations using a hardcoded certificate chain and makes them available using a HTTP server. It includes a public key and user data that can be used to extend the chain of trust of the attestation by other enclave applications.

IMPORTANT: The attestations generated by this server are NOT real and NOT really secure. They are meant to be used during local development or a testing environment. The mock root key used to generate the attestation: `6c79411ebaae7489a4e8355545c0346784b31df5d08cb1f7c0097836a82f67240f2a7201862880a1d09a0bb326637188fbbafab47a10abe3630fcf8c18d35d96532184985e582c0dce3dace8441f37b9cc9211dff935baae69e4872cc3494410`.

## Build

```bash
cargo build --release
```

### Reproducible builds

Reproducible builds can be done using Nix. The monorepo provides a Nix flake which includes this project and can be used to trigger builds:

```bash
nix build -v .#<flavor>.attestation.server-mock.<output>
```

Supported flavors:
- `gnu`
- `musl`

Supported outputs:
- `default`, same as `compressed`
- `uncompressed`
- `compressed`, using `upx`
- `docker`, `uncompressed` binary packaged into a docker tar

## Usage

```
$ ./target/release/oyster-attestation-server-mock --help
http server for mock handling attestation document requests based on a hardcoded certificate chain
Usage: oyster-attestation-server-mock --ip-addr <IP_ADDR> --pub-key <PUB_KEY> --user-data <USER_DATA>
Options:
  -i, --ip-addr <IP_ADDR>      ip address of the server (e.g. 127.0.0.1:1300)
  -p, --pub-key <PUB_KEY>      path to public key file (e.g. /app/id.pub)
      --user-data <USER_DATA>  path to user data file (e.g. /app/init-params-digest)
  -h, --help                   Print help
  -V, --version                Print version
```

## Endpoints

The mock attestation server exposes attestations through two endpoints which encode the attestation in one of two format - raw and hex. The raw format is a binary format with the raw bytes of the attestation. The hex format is the same attestation, simply hex encoded. Therefore, the raw format is about half the size of the other while the hex format is ASCII letters and numbers only.

### Raw

#### Endpoint

`/attestation/raw`

#### Example

```
$ curl <ip:port>/attestation/raw -vs | xxd
*   Trying <ip:port>...
* Connected to <ip> (<ip>) port <port> (#0)
> GET /attestation/raw HTTP/1.1
> Host: <ip:port>
> User-Agent: curl/8.5.0
> Accept: */*
> 
< HTTP/1.1 200 OK
< content-type: application/octet-stream
< content-length: 2009
< date: Thu, 03 Apr 2025 11:11:52 GMT
< 
{ [2009 bytes data]
* Connection #0 to host <ip> left intact
00000000: 8444 a101 3822 a059 076d a969 6d6f 6475  .D..8".Y.m.imodu
00000010: 6c65 5f69 6478 2769 2d30 6436 3962 6563  le_idx'i-0d69bec
00000020: 3434 3761 3033 3761 3261 2d65 6e63 3031  447a037a2a-enc01
00000030: 3933 3961 6162 3139 3161 6164 6432 6664  939aab191aadd2fd
00000040: 6967 6573 7466 5348 4133 3834 6974 696d  igestfSHA384itim
00000050: 6573 7461 6d70 1b00 0001 95fb 59ab 2e64  estamp......Y..d
...
...
```

### Hex

#### Endpoint

`/attestation/hex`

#### Example

```
$ curl <ip:port>/attestation/hex -vs
*   Trying <ip:port>...
* Connected to <ip> (<ip>) port <port> (#0)
> GET /attestation/hex HTTP/1.1
> Host: <ip:port>
> User-Agent: curl/8.5.0
> Accept: */*
> 
< HTTP/1.1 200 OK
< content-type: text/plain; charset=utf-8
< content-length: 4018
< date: Thu, 03 Apr 2025 11:15:45 GMT
< 
8444a1013822a059076da9696d6f64756c655f696478276...
...
```

## License

This project is licensed under the Apache License, Version 2.0. See [LICENSE.txt](./LICENSE.txt).
